{{- $firmware_version := or .firmware_version "1.20190925" -}}
{{- $suite := or .suite "buster" -}}
{{- $image := or .image (printf "debian-%s-rpi3.img" $suite) -}}

architecture: arm64

actions:
  - action: recipe
    description: Package for {{ $suite }}
    recipe: debian-package-rpi.yaml
    variables:
      firmware_version: {{ $firmware_version }}
      suite: {{ $suite }}
      pack: false

  - action: overlay
    source: overlays/u-boot-menu

  - action: run
    chroot: true
    command: u-boot-update

  - action: image-partition
    imagename: {{ $image }}
    imagesize: 1GB
    partitiontype: msdos
    mountpoints:
      - mountpoint: /
        partition: root
      - mountpoint: /boot/firmware
        partition: firmware
        options: [ x-systemd.automount ]
    partitions:
      - name: firmware
        fs: fat32
        start: 0%
        end: 64MB
      - name: root
        fs: ext4
        start: 64MB
        end: 100%
        flags: [ boot ]

  - action: filesystem-deploy
    description: Deploying filesystem onto image

  - action: run
    description: Create block map file
    postprocess: true
    command: bmaptool create {{ $image }} > {{ $image }}.bmap

  - action: run
    description: Compressing final image
    postprocess: true
    command: gzip -f {{ $image }}
